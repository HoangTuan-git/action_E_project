# TÃªn cá»§a workflow
name: CI - Unit Tests & Build Images (Cached)

# CÃ¡c sá»± kiá»‡n kÃ­ch hoáº¡t workflow
on: [push, pull_request]

jobs:
  # ============================================================
  # JOB DUY NHáº¤T: Unit Tests + Build vá»›i Cache
  # ============================================================
  test-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # Step 1: Checkout mÃ£ nguá»“n
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js vá»›i npm cache (tÄƒng tá»‘c npm install)
      - name: Setup Node.js with npm cache
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            auth/package-lock.json
            product/package-lock.json

      # Step 3: Install dependencies cho táº¥t cáº£ services (parallel)
      - name: Install dependencies (all services)
        run: |
          echo "ðŸ“¦ Installing dependencies with cache..."
          npm ci --prefix auth &
          npm ci --prefix product &
          wait
          echo "âœ… Dependencies installed"

      # Step 4: Táº¡o .env files cho testing
      - name: Create .env files for testing
        run: |
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> auth/.env
          echo "NODE_ENV=test" >> auth/.env
          
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> product/.env
          echo "NODE_ENV=test" >> product/.env
          
          echo "âœ… Environment files created"

      # Step 5: Run unit tests (parallel)
      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          npm test --prefix auth &
          npm test --prefix product &
          wait
          echo "âœ… All unit tests passed"

      # Step 6: Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 7: Build Docker images vá»›i GitHub Actions Cache
      # Cache nÃ y sáº½ lÆ°u Docker layers, giÃºp build nhanh hÆ¡n
      - name: Build auth-service (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ./auth
          push: false
          tags: auth-service:latest
          cache-from: type=gha,scope=auth
          cache-to: type=gha,mode=max,scope=auth

      - name: Build product-service (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ./product
          push: false
          tags: product-service:latest
          cache-from: type=gha,scope=product
          cache-to: type=gha,mode=max,scope=product

      - name: Build order-service (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ./order
          push: false
          tags: order-service:latest
          cache-from: type=gha,scope=order
          cache-to: type=gha,mode=max,scope=order

      - name: Build api-gateway (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ./api-gateway
          push: false
          tags: api-gateway:latest
          cache-from: type=gha,scope=gateway
          cache-to: type=gha,mode=max,scope=gateway

      # Step 8: Report success
      - name: Report build summary
        run: |
          echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auth service unit tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Product service unit tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Images Built (Cached)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… auth-service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… product-service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… order-service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… api-gateway" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Ready for E2E tests and deployment"